import cv2
import os
import numpy as np


# path to data folder
INPUT_PATH = "."
OUTPUT_PATH = "."

labels = {}

for filename in os.listdir(f'{INPUT_PATH}/labels'):

    print(f'Getting labels from {filename}...')
    
    # open file and read lines
    f = open(f'{INPUT_PATH}/labels/{filename}', 'r')
    lines = f.readlines()

    # iterate over lines and add to labels
    for line in lines:
        binary = line.split(',')[0]
        label = line.split(',')[2]
        labels[binary] = label

progress = 0

for filename in os.listdir(f'{INPUT_PATH}/binaries'):

    progress += 1

    percent = progress / len(os.listdir(f"{INPUT_PATH}/binaries")) * 100
    print(f'Processing binary {filename}... (%.2f%%)' % percent)
    
    # read binary data
    f = open(f'{INPUT_PATH}/binaries/{filename}', 'rb').read()

    # calculate image heights
    width = 256
    height = 512

    # create image
    img = np.zeros((height, width , 3), dtype=np.uint8)

    # add truncated data to image
    i = 0
    h = 0
    w = 0
    while i < len(f) - 2 and i < height * width * 3 - 2:
        r = f[i]
        g = f[i + 1]
        b = f[i + 2]
        img[h][w] = [r, g, b]

        w += 1
        if w >= width:
            w = 0
            h += 1

        i += 3

    # make dir if not exists
    path = f'{OUTPUT_PATH}/images/{labels.get(filename) if labels.get(filename) else "Unknown"}'
    if not os.path.exists(path):
        os.mkdir(path)

    # save image
    cv2.imwrite(f'{path}/{filename}.png', img)